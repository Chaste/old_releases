<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <title>InstallGuides/Arc - Chaste</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://chaste.github.io/old_releases/trac.css" type="text/css" />
    <link rel="stylesheet" href="https://chaste.github.io/old_releases/wiki.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://chaste.github.io/old_releases/site.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <p>
          <a id="logo" href="https://chaste.github.io/"><img src="https://chaste.github.io/chaste_0256.png" alt="Chaste logo" height="60" /></a>
          <em>Documentation for <a href="https://chaste.github.io/old_releases/release_3.3/">Release 3.3</a>.</em>
        </p>
      </div>
    </div>
    <p>&nbsp;</p>
    <div id="content" class="wiki">
      <div class="wikipage searchable">
        
          <div id="wikipage" class="trac-content"><h1 id="OnARCAdvancedResearchComputingmachinessuchasHALandSAL">On ARC (Advanced Research Computing) machines such as HAL and SAL</h1>
<h2 id="Gettingontothemachine">Getting onto the machine</h2>
<p>
For access to HAL, SAL, or any of the other OeRC machines, you will need to register with <a class="ext-link" href="http://www.arc.ox.ac.uk/content/home"><span class="icon">​</span>Advanced Research Computing</a> (ARC, formerly the Oxford Supercomputing Centre).
The easiest way to join is to register for a user account with an existing project - take a look at the list of projects on the <a class="ext-link" href="http://www.arc.ox.ac.uk/content/registration"><span class="icon">​</span>registration page</a> and talk to the person responsible for the one you would like to join.
</p>
<p>
ARC runs a few training courses each year for new users. The notes for these courses are available <a class="ext-link" href="http://www.arc.ox.ac.uk/content/training-courses-0"><span class="icon">​</span>online</a>, and might be worth a look.
</p>
<p>
These instructions were last checked by Louise and Beth in Spring 2014 (using cardiac Chaste on HAL). Changes may be required to get Chaste running on ARCUS.
</p>
<h2 id="Settingtheenvironment">Setting the environment</h2>
<p>
You will need <tt>SCons</tt> and the Intel compiler to compile code and RNV for compiling CellML files into Chaste compatible cell models.
</p>
<p>
As of February 2014, the Intel compiler was automatically set up, but <tt>SCons</tt> and <tt>VTK</tt> still need to be added. Another required dependency, Amara, is available if you load the <tt>Python 2.6</tt> module.
</p>
<p>
For these add the following to your <tt>$HOME/.bashrc</tt> file:
</p>
<pre class="wiki">module add scons
module add python/2.7
module load vtk/5.10.1
module load intel-compilers/2013
module load intel-mkl/2013

#Path for PyCML Python helper 
export PATH=${PATH}:/system/software/hal/lib/rnv-1.7.8/

#Libraries for running Chaste
LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/system/software/redqueen/libs/boost-1_45_0/lib:/system/software/hal/lib/xerces-c/lib:/home/system/software/redqueen/libs/szip-2.1/lib:${DATA}/Chaste/lib
</pre><p>
You should check that the modules have been loaded correctly by using the <tt>module list</tt> command.
</p>
<h2 id="GettingChaste">Getting Chaste</h2>
<p>
It makes sense to download Chaste in your $DATA area where there is ample space to store code, meshes and output.
</p>
<pre class="wiki">cd $DATA
# Check out code base (takes a few minutes)
svn co https://chaste.cs.ox.ac.uk/svn/chaste/trunk Chaste --username jmpf@comlab.ox.ac.uk
#                                                         (the last bit will, of course, be your Chaste login)
# Check out a user project
svn co https://chaste.cs.ox.ac.uk/svn/chaste/projects/jmpf Chaste/projects/jmpf
#                                                    (the last parts will, of course, be your Chaste project name)
</pre><h2 id="Compilingatest">Compiling a test</h2>
<p>
It's important to <em>compile only</em> and not to attempt to run programs on the head-node.  As of <a class="missing changeset" title="No permission to view changeset 15416 on (default)">r15416</a> the SCons build system should automatically pick up a configuration file based on previous configurations written by Nejib and Joe. This configuration does not support CVODE - the changes to the hostconfig file to enable CVODE will be provided on this page later.
</p>
<pre class="wiki">cd $DATA/Chaste

# Compiling a simple parallel test
scons build=Intel compile_only=1 test_suite=global/test/TestPetscTools.hpp
# Compiling PyCml test
scons b=Intel co=1 ts=heart/test/ionicmodels/TestPyCml.hpp
# Compiling a user project test
scons b=Intel co=1 ts=projects/jmpf/test/TestVtk.hpp

#Compiling the main Chaste executable
scons b=Intel co=1 exe=1 chaste_libs=1 apps
</pre><h2 id="Runningcode">Running code</h2>
<p>
Here is an example script which runs the above test and the Chaste executable.  Save as, for example, <tt>run_Chaste</tt>.
</p>
<pre class="wiki">#!/bin/bash --login

# Name of the job 
#PBS -N TestChaste

# Use 1 node with 8 cores = 8 MPI legs 
#PBS -l nodes=1:ppn=8

# Kill after one hour 
#PBS -l walltime=01:00:00

# Send me email at the beginning and the end of the run
#PBS -m be
#PBS -M jmpf@cs.ox.ac.uk 

# Join output and error files
#PBS -j oe

# Copy all environmental variables
#PBS -V 

# Set up MPI
cd $PBS_O_WORKDIR
. enable_hal_mpi.sh

#Switch to Chaste directory
cd ${DATA}/Chaste

# A parallel test
mpirun $MPI_HOSTS ./global/build/intel/TestPetscToolsRunner
# A PyCML test
mpirun $MPI_HOSTS ./heart/build/intel/ionicmodels/TestPyCmlRunner
# A user project test
mpirun $MPI_HOSTS ./projects/jmpf/build/intel/TestVtkRunner

# A test of the executable
mpirun $MPI_HOSTS apps/src/Chaste apps/texttest/weekly/Propagation1d/ChasteParameters.xml
</pre><p>
Submit script and see state of the queue
</p>
<pre class="wiki">qsub run_Chaste.sh
qstat
</pre><p>
More information on the Torque job scheduler is available <a class="ext-link" href="http://www.arc.ox.ac.uk/content/torque-job-scheduler"><span class="icon">​</span>here</a>.
</p>
<h2 id="UsingCVODE">Using CVODE</h2>
<p>
There are some problems with using the default oerc.py found in python/hostconfig/machines if you want to use CVODE. To get around these problems, make a copy of oerc.py at python/hostconfig/local.py and replace the CVODE section at the end with the following.
</p>
<pre class="wiki">    # Chaste may also optionally link against CVODE.
    # CVODE is not installed - line below is now set to "True"
    use_cvode = int(prefs.get('use-cvode', True))
    if use_cvode:
        # Look for the version of CVODE in the folder where it is located (part of PETSc)
        DetermineCvodeVersion('/system/software/hal/lib/PETSc/petsc-3.0.0-p12/icc-2011/include')
        # Now add the CVODE libraries to the list
        other_libraries.extend(['sundials_cvode', 'sundials_nvecserial'])
</pre><h2 id="Troubleshooting">Troubleshooting</h2>
<p>
If you receive a python error of the kind
</p>
<pre class="wiki">python: error while loading shared libraries: libpython2.7.so.1.0: cannot open shared object file: No such file or directory
</pre><p>
just go into your chaste directory and copy libpython2.7.so.1.0 into the ./lib directory
</p>
<pre class="wiki">cp /system/software/linux-x86_64/python/2.7.8/lib/libpython2.7.so.1.0 ./lib
</pre><p>
This is not the cleanest way of fixing the issue, but since HAL is going to be offline soon let's not bother about it further.
</p>
</div>
          

    </div>
  </body>
</html>

<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <title>UserTutorials/BidomainWithBath - Chaste</title>
    <link rel="stylesheet" href="https://chaste.github.io/old_releases/trac.css" type="text/css" />
    <link rel="stylesheet" href="https://chaste.github.io/old_releases/wiki.css" type="text/css" />
    <link rel="stylesheet" href="/trac/css/site.css" type="text/css" />
    <style type="text/css">
/* Link styles */
:link, :visited, a em {
 text-decoration: none;
 color: #283f6b;
 border-bottom: 1px dotted #bbb;
}
/*
:link:hover, :visited:hover {
 background-color: #eee;
 color: #555;
}
*/
    </style>

  </head>
  <body>
    <div id="banner">
      <div id="header">
        <p>
          <a id="logo" href="https://chaste.github.io/"><img src="https://chaste.github.io/chaste_0256.png" alt="Chaste logo" height="60" /></a>
          <em>Documentation for <a href="https://chaste.github.io/old_releases/release_2.1/">Release 2.1</a>.</em>
        </p>
      </div>
    </div>
    <p>&nbsp;</p>
    <div id="content" class="wiki">
      <p class="path noprint">
        <a class="pathentry" title="View UserTutorials" href="https://chaste.github.io/old_releases/release_2.1/UserTutorials.html">UserTutorials</a><span class="pathentry sep">/</span><a class="pathentry" title="View UserTutorials/BidomainWithBath" href="https://chaste.github.io/old_releases/release_2.1/UserTutorials/BidomainWithBath.html">BidomainWithBath</a>
        <br style="clear: both" />
      </p>
      <div class="wikipage searchable">
        
          <p>
This tutorial is automatically generated from the file trunk/heart/test/tutorials/TestBidomainWithBathTutorial.hpp at revision <a class="changeset" href="/cgi-bin/trac.cgi/changeset/10553" title="oops's">r10553</a>.
Note that the code is given in full at the bottom of the page.
</p>
<h1 id="Anexampleshowinghowtorunabidomainsimulationfortissuecontainedinaperfusingbath">An example showing how to run a bidomain simulation for tissue contained in a perfusing bath</h1>
<p>
In this tutorial we show how the changes the need to be made when running a simulation of
cardiac tissue contained in a bath.
The usual headers are included 
</p>
<div class="code"><pre><span class="cp">#include &lt;cxxtest/TestSuite.h&gt;
#include "BidomainProblem.hpp"
#include "PlaneStimulusCellFactory.hpp"
#include "LuoRudy1991.hpp"
#include "PetscSetupAndFinalize.hpp"
</span></pre></div><p>
This test will show how to load a mesh in the test and pass it into the problem,
for which the following includes are needed 
</p>
<div class="code"><pre><span class="cp">#include "TetrahedralMesh.hpp"
#include "TrianglesMeshReader.hpp"
</span></pre></div><p>
Define the test 
</p>
<div class="code"><pre>class TestRunningBidomainSimulationsTutorial <span class="o">:</span> public CxxTest<span class="o">::</span>TestSuite
<span class="p">{</span>
<span class="nl">public:</span> <span class="c">// Tests should be public!
</span>    <span class="kt">void</span> TestWithBathAndElectrodes<span class="p">()</span> throw <span class="p">(</span>Exception<span class="p">)</span>
    <span class="p">{</span>
</pre></div><p>
First, set the end time and output info. In this simulation
we'll explicitly read the mesh, alter it, then pass it
to the problem class, so we don't set the mesh file name.
</p>
<div class="code"><pre>        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetSimulationDuration<span class="p">(</span><span class="mf">3.0</span><span class="p">);</span>  <span class="c">//ms
</span>        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetOutputDirectory<span class="p">(</span><span class="s">"BidomainTutorialWithBath"</span><span class="p">);</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetOutputFilenamePrefix<span class="p">(</span><span class="s">"results"</span><span class="p">);</span>
</pre></div><p>
Bath problems seem to require decreased ODE timesteps.
</p>
<div class="code"><pre>        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetOdeTimeStep<span class="p">(</span><span class="mf">0.001</span><span class="p">);</span>  <span class="c">//ms
</span></pre></div><p>
Use the <tt>PlaneStimulusCellFactory</tt> to define a set
of Luo-Rudy cells. We pass the stimulus magnitude as 0.0
as we don't want any stimulated cells
</p>
<div class="code"><pre>        PlaneStimulusCellFactory<span class="o">&lt;</span>CellLuoRudy1991FromCellML<span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span> cell_factory<span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</pre></div><p>
Now, we load up a rectangular mesh (in triangle/tetgen format), done as follows,
using <tt>TrianglesMeshReader</tt>.
</p>
<div class="code"><pre>        TrianglesMeshReader<span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span> reader<span class="p">(</span><span class="s">"mesh/test/data/2D_0_to_1mm_400_elements"</span><span class="p">);</span>
        TetrahedralMesh<span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span> mesh<span class="p">;</span>
        mesh<span class="p">.</span>ConstructFromMeshReader<span class="p">(</span>reader<span class="p">);</span>
</pre></div><p>
In bath problems, each element has an attribute which must be set
to 0 (cardiac tissue) or 1 (bath). This can be done by having an
extra column in the element file (see the file formats documentation,
or for example
mesh/test/data/1D_0_to_1_10_elements_with_two_attributes.ele,
and note that the header in this file has 1 at the end to indicate that
the file defines an attribute for each element. We have read in a mesh
without this type of information set up, so we set it up manually,
by looping over elements and setting those more than 2mm from the centre
as bath elements (by default, the others are cardiac elements).
</p>
<div class="code"><pre>        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> i<span class="o">=</span><span class="mi">0</span><span class="p">;</span> i<span class="o">&lt;</span>mesh<span class="p">.</span>GetNumElements<span class="p">();</span> i<span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">double</span> x <span class="o">=</span> mesh<span class="p">.</span>GetElement<span class="p">(</span>i<span class="p">)</span><span class="o">-&gt;</span>CalculateCentroid<span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
            <span class="kt">double</span> y <span class="o">=</span> mesh<span class="p">.</span>GetElement<span class="p">(</span>i<span class="p">)</span><span class="o">-&gt;</span>CalculateCentroid<span class="p">()[</span><span class="mi">1</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span> sqrt<span class="p">((</span>x<span class="o">-</span><span class="mf">0.05</span><span class="p">)</span><span class="o">*</span><span class="p">(</span>x<span class="o">-</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>y<span class="o">-</span><span class="mf">0.05</span><span class="p">)</span><span class="o">*</span><span class="p">(</span>y<span class="o">-</span><span class="mf">0.05</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.02</span> <span class="p">)</span>
            <span class="p">{</span>
                mesh<span class="p">.</span>GetElement<span class="p">(</span>i<span class="p">)</span><span class="o">-&gt;</span>SetRegion<span class="p">(</span>HeartRegionCode<span class="o">::</span>BATH<span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
</pre></div><p>
Now we define the electrodes. First define the magnitude of the electrodes
(ie the magnitude of the boundary extracellular stimulus), and the duration
it lasts for. Currently, electrodes switch on at time 0 and have constant magnitude
until they are switched off. (Note that this test has a small range of
magnitudes that will work, perhaps because the electrodes are close to the tissue).
</p>
<div class="code"><pre>        <span class="c">//-1e4 is under threshold, -1.4e4 too high - crashes the cell model
</span>        <span class="kt">double</span> magnitude <span class="o">=</span> <span class="o">-</span><span class="mf">1.1e4</span><span class="p">;</span> <span class="c">// uA/cm^2
</span>        <span class="kt">double</span> start_time <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
        <span class="kt">double</span> duration <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c">//ms
</span></pre></div><p>
Electrodes work in two ways: the first electrode applies an input flux, and
the opposite electrode can either be grounded or apply an equal and opposite
flux (ie an output flux). The <tt>false</tt> here indicates the second electrode
is not grounded, ie has an equal and opposite flux. The "0" indicates
that the electrodes should be applied to the bounding surfaces in the x-direction
(1 would be y-direction, 2 z-direction), which are X=0.0 and X=0.1 in the given mesh.
(This explains why the full mesh ought to be rectangular/cuboid - the nodes on
x=xmin and x=xmax ought to be form two surfaces of equal area.
</p>
<div class="code"><pre>        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetElectrodeParameters<span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> magnitude<span class="p">,</span> start_time<span class="p">,</span> duration<span class="p">);</span>
</pre></div><p>
Now create the problem class, using the cell factory and passing
in <tt>true</tt> as the second argument to indicate we are solving a bath
problem..
</p>
<div class="code"><pre>        BidomainProblem<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> bidomain_problem<span class="p">(</span> <span class="o">&amp;</span>cell_factory<span class="p">,</span> <span class="nb">true</span> <span class="p">);</span>
</pre></div><p>
..set the mesh and electrodes.. 
</p>
<div class="code"><pre>        bidomain_problem<span class="p">.</span>SetMesh<span class="p">(</span><span class="o">&amp;</span>mesh<span class="p">);</span>
</pre></div><p>
..and solve as before. 
</p>
<div class="code"><pre>        bidomain_problem<span class="p">.</span>Initialise<span class="p">();</span>
        bidomain_problem<span class="p">.</span>Solve<span class="p">();</span>
</pre></div><p>
The results can be visualised as before. <strong>Note:</strong> The voltage is only
defined at cardiac nodes (a node contained in <i>any</i> cardiac element), but
for visualisation and computation a 'fake' value of ZERO is given for the
voltage at bath nodes.
</p>
<p>
Finally, we can check that an AP was induced in any of the cardiac
cells. We use a <tt>ReplicatableVector</tt> as before, and make sure we
only check the voltage at cardiac cells.
</p>
<div class="code"><pre>        Vec solution <span class="o">=</span> bidomain_problem<span class="p">.</span>GetSolution<span class="p">();</span> <span class="c">// the Vs and phi_e's, as a PetSc vector
</span>        ReplicatableVector solution_repl<span class="p">(</span>solution<span class="p">);</span>
        bool ap_triggered <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> i<span class="o">=</span><span class="mi">0</span><span class="p">;</span> i<span class="o">&lt;</span>mesh<span class="p">.</span>GetNumNodes<span class="p">();</span> i<span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span>mesh<span class="p">.</span>GetNode<span class="p">(</span>i<span class="p">)</span><span class="o">-&gt;</span>GetRegion<span class="p">()</span><span class="o">==</span>HeartRegionCode<span class="o">::</span>TISSUE<span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span>solution_repl<span class="p">[</span><span class="mi">2</span><span class="o">*</span>i<span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="c">// 2*i, ie the voltage for this node (would be 2*i+1 for phi_e for this node)
</span>                <span class="p">{</span>
                    ap_triggered <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        TS_ASSERT<span class="p">(</span>ap_triggered<span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div><h1 id="Code">Code</h1>
<p>
The full code is given below
</p>
<div class="code"><pre><span class="cp">#include &lt;cxxtest/TestSuite.h&gt;
#include "BidomainProblem.hpp"
#include "PlaneStimulusCellFactory.hpp"
#include "LuoRudy1991.hpp"
#include "PetscSetupAndFinalize.hpp"
#include "TetrahedralMesh.hpp"
#include "TrianglesMeshReader.hpp"
</span>
class TestRunningBidomainSimulationsTutorial <span class="o">:</span> public CxxTest<span class="o">::</span>TestSuite
<span class="p">{</span>
<span class="nl">public:</span> <span class="c">// Tests should be public!
</span>
    <span class="kt">void</span> TestWithBathAndElectrodes<span class="p">()</span> throw <span class="p">(</span>Exception<span class="p">)</span>
    <span class="p">{</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetSimulationDuration<span class="p">(</span><span class="mf">3.0</span><span class="p">);</span>  <span class="c">//ms
</span>        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetOutputDirectory<span class="p">(</span><span class="s">"BidomainTutorialWithBath"</span><span class="p">);</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetOutputFilenamePrefix<span class="p">(</span><span class="s">"results"</span><span class="p">);</span>

        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetOdeTimeStep<span class="p">(</span><span class="mf">0.001</span><span class="p">);</span>  <span class="c">//ms
</span>
        PlaneStimulusCellFactory<span class="o">&lt;</span>CellLuoRudy1991FromCellML<span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span> cell_factory<span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>

        TrianglesMeshReader<span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span> reader<span class="p">(</span><span class="s">"mesh/test/data/2D_0_to_1mm_400_elements"</span><span class="p">);</span>
        TetrahedralMesh<span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span> mesh<span class="p">;</span>
        mesh<span class="p">.</span>ConstructFromMeshReader<span class="p">(</span>reader<span class="p">);</span>

        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> i<span class="o">=</span><span class="mi">0</span><span class="p">;</span> i<span class="o">&lt;</span>mesh<span class="p">.</span>GetNumElements<span class="p">();</span> i<span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">double</span> x <span class="o">=</span> mesh<span class="p">.</span>GetElement<span class="p">(</span>i<span class="p">)</span><span class="o">-&gt;</span>CalculateCentroid<span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
            <span class="kt">double</span> y <span class="o">=</span> mesh<span class="p">.</span>GetElement<span class="p">(</span>i<span class="p">)</span><span class="o">-&gt;</span>CalculateCentroid<span class="p">()[</span><span class="mi">1</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span> sqrt<span class="p">((</span>x<span class="o">-</span><span class="mf">0.05</span><span class="p">)</span><span class="o">*</span><span class="p">(</span>x<span class="o">-</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>y<span class="o">-</span><span class="mf">0.05</span><span class="p">)</span><span class="o">*</span><span class="p">(</span>y<span class="o">-</span><span class="mf">0.05</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.02</span> <span class="p">)</span>
            <span class="p">{</span>
                mesh<span class="p">.</span>GetElement<span class="p">(</span>i<span class="p">)</span><span class="o">-&gt;</span>SetRegion<span class="p">(</span>HeartRegionCode<span class="o">::</span>BATH<span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c">//-1e4 is under threshold, -1.4e4 too high - crashes the cell model
</span>        <span class="kt">double</span> magnitude <span class="o">=</span> <span class="o">-</span><span class="mf">1.1e4</span><span class="p">;</span> <span class="c">// uA/cm^2
</span>        <span class="kt">double</span> start_time <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
        <span class="kt">double</span> duration <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c">//ms
</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetElectrodeParameters<span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> magnitude<span class="p">,</span> start_time<span class="p">,</span> duration<span class="p">);</span>

        BidomainProblem<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> bidomain_problem<span class="p">(</span> <span class="o">&amp;</span>cell_factory<span class="p">,</span> <span class="nb">true</span> <span class="p">);</span>

        bidomain_problem<span class="p">.</span>SetMesh<span class="p">(</span><span class="o">&amp;</span>mesh<span class="p">);</span>

        bidomain_problem<span class="p">.</span>Initialise<span class="p">();</span>
        bidomain_problem<span class="p">.</span>Solve<span class="p">();</span>

        Vec solution <span class="o">=</span> bidomain_problem<span class="p">.</span>GetSolution<span class="p">();</span> <span class="c">// the Vs and phi_e's, as a PetSc vector
</span>        ReplicatableVector solution_repl<span class="p">(</span>solution<span class="p">);</span>

        bool ap_triggered <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> i<span class="o">=</span><span class="mi">0</span><span class="p">;</span> i<span class="o">&lt;</span>mesh<span class="p">.</span>GetNumNodes<span class="p">();</span> i<span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span>mesh<span class="p">.</span>GetNode<span class="p">(</span>i<span class="p">)</span><span class="o">-&gt;</span>GetRegion<span class="p">()</span><span class="o">==</span>HeartRegionCode<span class="o">::</span>TISSUE<span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span>solution_repl<span class="p">[</span><span class="mi">2</span><span class="o">*</span>i<span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="c">// 2*i, ie the voltage for this node (would be 2*i+1 for phi_e for this node)
</span>                <span class="p">{</span>
                    ap_triggered <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        TS_ASSERT<span class="p">(</span>ap_triggered<span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
        
        
      </div>

    </div>
  </body>
</html>

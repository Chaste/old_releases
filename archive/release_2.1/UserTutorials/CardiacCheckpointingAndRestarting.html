<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <title>UserTutorials/CardiacCheckpointingAndRestarting - Chaste</title>
    <link rel="stylesheet" href="/trac/css/trac.css" type="text/css" />
    <link rel="stylesheet" href="/trac/css/wiki.css" type="text/css" />
    <link rel="stylesheet" href="/trac/css/site.css" type="text/css" />
    <style type="text/css">
/* Link styles */
:link, :visited, a em {
 text-decoration: none;
 color: #283f6b;
 border-bottom: 1px dotted #bbb;
}
/*
:link:hover, :visited:hover {
 background-color: #eee;
 color: #555;
}
*/
    </style>

  </head>
  <body>
    <div id="banner">
      <div id="header">
        <p>
          <a id="logo" href="http://www.comlab.ox.ac.uk/chaste"><img src="/logos/chaste-266x60.jpg" alt="Chaste logo" height="60" width="266" /></a>
          <em>Documentation for <a href="/chaste/tutorials/release_2.1/">Release 2.1</a>.</em>
        </p>
      </div>
    </div>
    <p>&nbsp;</p>
    <div id="content" class="wiki">
      <p class="path noprint">
        <a class="pathentry" title="View UserTutorials" href="/chaste/tutorials/release_2.1/UserTutorials.html">UserTutorials</a><span class="pathentry sep">/</span><a class="pathentry" title="View UserTutorials/CardiacCheckpointingAndRestarting" href="/chaste/tutorials/release_2.1/UserTutorials/CardiacCheckpointingAndRestarting.html">CardiacCheckpointingAndRestarting</a>
        <br style="clear: both" />
      </p>
      <div class="wikipage searchable">
        
          <p>
This tutorial is automatically generated from the file trunk/heart/test/tutorials/TestCardiacCheckpointingAndRestartingTutorial.hpp at revision <a class="changeset" href="/cgi-bin/trac.cgi/changeset/10664" title="#1586 Erroneous comment">r10664</a>.
Note that the code is given in full at the bottom of the page.
</p>
<h1 id="Checkpointingandrestartingcardiacsimulations">Checkpointing and restarting cardiac simulations</h1>
<p>
In this tutorial we show how to save and reload cardiac simulations
</p>
<p>
<tt>CardiacSimulationArchiver</tt> has to be included. Archiving includes often have to be included first.
</p>
<div class="code"><pre><span class="cp">#include &lt;cxxtest/TestSuite.h&gt;
#include "CardiacSimulationArchiver.hpp"
#include "BidomainProblem.hpp"
#include "LuoRudy1991.hpp"
#include "PetscSetupAndFinalize.hpp"
#include "PlaneStimulusCellFactory.hpp"
</span>class TestCardiacCheckpointingAndRestartingTutorial <span class="o">:</span> public CxxTest<span class="o">::</span>TestSuite
<span class="p">{</span>
<span class="nl">public:</span>
</pre></div><p>
First, the checkpointing test. 
</p>
<div class="code"><pre>    <span class="kt">void</span> <span class="nf">TestCheckpointing</span><span class="p">()</span> throw<span class="p">(</span>Exception<span class="p">)</span>
    <span class="p">{</span>
</pre></div><p>
We set up exactly the same simulation as in <a class="wiki" href="/chaste/tutorials/release_2.1/UserTutorials/AnotherBidomainSimulation.html">UserTutorials/AnotherBidomainSimulation</a> 
</p>
<div class="code"><pre>        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>Reset<span class="p">();</span>
        PlaneStimulusCellFactory<span class="o">&lt;</span>CellLuoRudy1991FromCellML<span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span> cell_factory<span class="p">(</span><span class="o">-</span><span class="mi">2000000</span><span class="p">);</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetSimulationDuration<span class="p">(</span><span class="mf">5.0</span><span class="p">);</span> <span class="c">//ms
</span>        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetOutputDirectory<span class="p">(</span><span class="s">"BidomainCheckpointingTutorial"</span><span class="p">);</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetOutputFilenamePrefix<span class="p">(</span><span class="s">"results"</span><span class="p">);</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetMeshFileName<span class="p">(</span><span class="s">"mesh/test/data/2D_0_to_1mm_800_elements"</span><span class="p">,</span> cp<span class="o">::</span>media_type<span class="o">::</span>Orthotropic<span class="p">);</span>
        <span class="kt">double</span> scale <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetIntracellularConductivities<span class="p">(</span>Create_c_vector<span class="p">(</span><span class="mf">1.75</span><span class="o">*</span>scale<span class="p">,</span> <span class="mf">0.19</span><span class="o">*</span>scale<span class="p">));</span>
        BidomainProblem<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> bidomain_problem<span class="p">(</span> <span class="o">&amp;</span>cell_factory <span class="p">);</span>
        bidomain_problem<span class="p">.</span>Initialise<span class="p">();</span>
        bidomain_problem<span class="p">.</span>Solve<span class="p">();</span>
</pre></div><p>
To save the entire simulation, use the <tt>CardiacSimulationArchiver</tt> class, as shown in the following.
Note the <tt>BidomainProblem&lt;2&gt;</tt> as the template parameter. The output directory is relative to
CHASTE_TEST_OUTPUT. 
</p>
<div class="code"><pre>        CardiacSimulationArchiver<span class="o">&lt;</span>BidomainProblem<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> <span class="o">&gt;::</span>Save<span class="p">(</span>bidomain_problem<span class="p">,</span> <span class="s">"BidomainCheckpointingTutorial/saved_simulation"</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div><p>
This is how to restart the test. 
</p>
<div class="code"><pre>    <span class="kt">void</span> <span class="nf">TestRestarting</span><span class="p">()</span> throw<span class="p">(</span>Exception<span class="p">)</span>
    <span class="p">{</span>
</pre></div><p>
To restart from the saved simulation directory we  use the <tt>CardiacSimulationArchiver</tt> class, as shown in the following.
Note the <tt>BidomainProblem&lt;2&gt;</tt> as the template parameter again.  The dimension (2) must match the one given in the
saved archive directory.
The output directory is again relative to CHASTE_TEST_OUTPUT. 
</p>
<div class="code"><pre>        BidomainProblem<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;*</span> p_bidomain_problem <span class="o">=</span> CardiacSimulationArchiver<span class="o">&lt;</span>BidomainProblem<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> <span class="o">&gt;::</span>Load<span class="p">(</span><span class="s">"BidomainCheckpointingTutorial/saved_simulation"</span><span class="p">);</span>
</pre></div><p>
The simulation duration has to be amended.
Note that the duration is always given with respect to the origin of the first solve.
This means that we are running from <tt>t=5 ms</tt> (the end of the previous simulation) to <tt>t=10 ms</tt>.
The output files are concatenated so that they appear to be made by a single simulation running from
<tt>t=0 ms</tt> to <tt>t=10 ms</tt>.
</p>
<div class="code"><pre>        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetSimulationDuration<span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="c">//ms
</span></pre></div><p>
The point of checkpointing and restarting is that there may be something which we want to change
during the course of experiment.  Here we change the conductivity. 
</p>
<div class="code"><pre>        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetIntracellularConductivities<span class="p">(</span>Create_c_vector<span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">));</span>
        p_bidomain_problem<span class="o">-&gt;</span>Solve<span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div><h1 id="Code">Code</h1>
<p>
The full code is given below
</p>
<div class="code"><pre><span class="cp">#include &lt;cxxtest/TestSuite.h&gt;
#include "CardiacSimulationArchiver.hpp"
#include "BidomainProblem.hpp"
#include "LuoRudy1991.hpp"
#include "PetscSetupAndFinalize.hpp"
#include "PlaneStimulusCellFactory.hpp"
</span>
class TestCardiacCheckpointingAndRestartingTutorial <span class="o">:</span> public CxxTest<span class="o">::</span>TestSuite
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="kt">void</span> TestCheckpointing<span class="p">()</span> throw<span class="p">(</span>Exception<span class="p">)</span>
    <span class="p">{</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>Reset<span class="p">();</span>

        PlaneStimulusCellFactory<span class="o">&lt;</span>CellLuoRudy1991FromCellML<span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span> cell_factory<span class="p">(</span><span class="o">-</span><span class="mi">2000000</span><span class="p">);</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetSimulationDuration<span class="p">(</span><span class="mf">5.0</span><span class="p">);</span> <span class="c">//ms
</span>        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetOutputDirectory<span class="p">(</span><span class="s">"BidomainCheckpointingTutorial"</span><span class="p">);</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetOutputFilenamePrefix<span class="p">(</span><span class="s">"results"</span><span class="p">);</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetMeshFileName<span class="p">(</span><span class="s">"mesh/test/data/2D_0_to_1mm_800_elements"</span><span class="p">,</span> cp<span class="o">::</span>media_type<span class="o">::</span>Orthotropic<span class="p">);</span>

        <span class="kt">double</span> scale <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetIntracellularConductivities<span class="p">(</span>Create_c_vector<span class="p">(</span><span class="mf">1.75</span><span class="o">*</span>scale<span class="p">,</span> <span class="mf">0.19</span><span class="o">*</span>scale<span class="p">));</span>
        BidomainProblem<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> bidomain_problem<span class="p">(</span> <span class="o">&amp;</span>cell_factory <span class="p">);</span>

        bidomain_problem<span class="p">.</span>Initialise<span class="p">();</span>
        bidomain_problem<span class="p">.</span>Solve<span class="p">();</span>

        CardiacSimulationArchiver<span class="o">&lt;</span>BidomainProblem<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> <span class="o">&gt;::</span>Save<span class="p">(</span>bidomain_problem<span class="p">,</span> <span class="s">"BidomainCheckpointingTutorial/saved_simulation"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> TestRestarting<span class="p">()</span> throw<span class="p">(</span>Exception<span class="p">)</span>
    <span class="p">{</span>
        BidomainProblem<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;*</span> p_bidomain_problem <span class="o">=</span> CardiacSimulationArchiver<span class="o">&lt;</span>BidomainProblem<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> <span class="o">&gt;::</span>Load<span class="p">(</span><span class="s">"BidomainCheckpointingTutorial/saved_simulation"</span><span class="p">);</span>

        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetSimulationDuration<span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="c">//ms
</span>
        HeartConfig<span class="o">::</span>Instance<span class="p">()</span><span class="o">-&gt;</span>SetIntracellularConductivities<span class="p">(</span>Create_c_vector<span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">));</span>

        p_bidomain_problem<span class="o">-&gt;</span>Solve<span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
        
        
      </div>

    </div>
  </body>
</html>
